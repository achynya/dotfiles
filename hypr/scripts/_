#!/bin/bash

HISTFILE="$HOME/.local/share/clipboard-manager/history"
SEPARATOR="---ENTRY---"
MAX_BLOCKS=100
TMPFILE=$(mktemp)
ROFI_PROMPT="üìã Clipboard"
DELETE_KEY="Alt+U"

mkdir -p "$(dirname "$HISTFILE")"
touch "$HISTFILE"

# –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
CURRENT=$(wl-paste --no-newline)

# –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ
if [[ -n "$CURRENT" ]]; then
    if ! grep -Fzxq "$CURRENT" "$HISTFILE"; then
        printf "%s\n%s\n" "$SEPARATOR" "$CURRENT" >> "$HISTFILE"
    fi
fi

# –û–±—Ä–µ–∑–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–æ MAX_BLOCKS
awk -v RS="$SEPARATOR" -v max="$MAX_BLOCKS" '
NR > 1 {blocks[++count]=$0}
END {
    start=(count > max ? count - max + 1 : 1)
    for (i=start; i<=count; i++) {
        print "---ENTRY---\n" blocks[i]
    }
}' "$HISTFILE" > "$TMPFILE" && mv "$TMPFILE" "$HISTFILE"

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –±–ª–æ–∫–æ–≤ (–Ω–æ–≤–æ–µ —Å–≤–µ—Ä—Ö—É)
mapfile -t BLOCKS < <(awk -v RS="$SEPARATOR" 'NR > 1 {print $0}' "$HISTFILE" | tac)

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–≤—å—é
PREVIEWS=()
for BLOCK in "${BLOCKS[@]}"; do
    preview=$(echo "$BLOCK" | head -n 3 | tr '\n' '‚èé')
    PREVIEWS+=("$preview")
done

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é rofi
CHOSEN_INDEX=$(printf "%s\n" "${PREVIEWS[@]}" | rofi -dmenu -i -p "$ROFI_PROMPT" \
    -kb-custom-1 "$DELETE_KEY" -format i -mesg "üóë Alt+U ‚Äî —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –±–ª–æ–∫")

# –û—Ç–º–µ–Ω–∞
[[ -z "$CHOSEN_INDEX" ]] && exit 0

# –£–¥–∞–ª–µ–Ω–∏–µ –±–ª–æ–∫–∞
if [[ "$CHOSEN_INDEX" == *custom-1 ]]; then
    REAL_INDEX=$(echo "$CHOSEN_INDEX" | cut -d: -f1)
    KEEP=()
    for i in "${!BLOCKS[@]}"; do
        [[ $i -ne $REAL_INDEX ]] && KEEP+=("${BLOCKS[i]}")
    done
    : > "$HISTFILE"
    for block in "${KEEP[@]}"; do
        printf "%s\n%s\n" "$SEPARATOR" "$block" >> "$HISTFILE"
    done
    notify-send "üìã –ë–ª–æ–∫ —É–¥–∞–ª—ë–Ω"
    exit 0
fi

# –í—Å—Ç–∞–≤–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –±–ª–æ–∫–∞ –≤ –±—É—Ñ–µ—Ä
CHOSEN_BLOCK="${BLOCKS[$CHOSEN_INDEX]}"
echo -n "$CHOSEN_BLOCK" | wl-copy

